#!/bin/sh
set -e

RUNDIR="/var/run/tcall"
LOGDIR="/var/log/tcall"

REQ="$RUNDIR/user_request"
APP="$RUNDIR/pending_approval"
LOG="$LOGDIR/audit.log"

# --- Runtime setup ---
mkdir -p "$RUNDIR" "$LOGDIR"

chown root:tcall "$RUNDIR" "$LOGDIR"
chmod 770 "$RUNDIR"
chmod 770 "$LOGDIR"

[ -f "$REQ" ] || touch "$REQ"
[ -f "$APP" ] || touch "$APP"
[ -f "$LOG" ] || touch "$LOG"

chown root:tcall "$REQ" "$APP" "$LOG"
chmod 660 "$REQ" "$APP" "$LOG"

echo "$(date) | SUPERVISOR_STARTED" >> "$LOG"

# --- Main loop ---
while true; do
    if read -r LINE < "$REQ"; then
        USER="$(echo "$LINE" | cut -d'|' -f1)"
        CMD="$(echo "$LINE" | cut -d'|' -f2-)"

        echo "$(date) | REQUEST | user=$USER cmd=$CMD" >> "$LOG"

        case "$CMD" in
            df*|free*|uptime*)
                echo "$(date) | ALLOWED | user=$USER cmd=$CMD" >> "$LOG"
                sh -c "$CMD" >> "$LOG" 2>&1
                ;;
            *)
                printf "%s|%s\n" "$USER" "$CMD" > "$APP"
                echo "$(date) | REQUIRES_ADMIN | user=$USER cmd=$CMD" >> "$LOG"
                ;;
        esac
    fi
done

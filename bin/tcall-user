#!/bin/sh

RUNDIR="/var/run/tcall"
USER="$(whoami)"
SESSION="$RUNDIR/session_$USER"
REQ="$RUNDIR/user_request"
LOG="/var/log/tcall/audit.log"

[ -f "$SESSION" ] || { echo "No active admin session"; exit 1; }

EXP=$(cat "$SESSION")
NOW=$(date +%s)

[ "$NOW" -gt "$EXP" ] && { echo "Session expired"; exit 1; }

echo "Tcall session active (single-admin controlled)"

while true; do
  printf "tcall> "
  read -r CMD || exit 0

  [ "$CMD" = "exit" ] && exit 0

  echo "$(date) | CMD | user=$USER cmd=$CMD" >> "$LOG"

  case "$CMD" in
    sudo\ *)
      REAL="${CMD#sudo }"
      printf "%s|%s\n" "$USER" "$REAL" > "$REQ"
      echo "Sent to admin for approval"
      ;;
    *)
      /usr/bin/script -q -c "$CMD" /var/log/tcall/session_$USER.log
      ;;
  esac
done
